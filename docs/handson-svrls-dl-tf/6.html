<html><head/><body><html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Creating a Deep Learning Pipeline</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">创建深度学习管道</h1>

                

            

            

                

<p>在上一章中，我们学习了使用AWS控制台创建API网关服务，以及无服务器框架。在本章中，我们将学习使用AWS控制台以及无服务器框架创建SQS连接。</p>

<p>在本章中，我们将讨论以下主题:</p>

<ul>

<li>信息排队</li>

<li>AWS简单查询服务简介</li>

<li>使用AWS控制台和无服务器框架创建AWS SQS</li>

<li>样本项目——深度学习管道</li>

</ul>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Technical Requirements</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">技术要求</h1>

                

            

            

                

<p>本章中的技术要求如下:</p>

<ul>

<li>AWS订阅</li>

<li>Python 3.6</li>

<li>AWS CLI</li>

<li>无服务器框架</li>

<li>你可以在<a href="https://github.com/PacktPublishing/Hands-On-Serverless-Deep-Learning-with-TensorFlow-and-AWS-Lambda">https://github . com/packt publishing/Hands-On-server less-Deep-Learning-with-tensor flow-and-AWS-Lambda</a>找到所有代码</li>

</ul>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Message queue</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">信息排队</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">消息队列是不同服务之间交互的一种重要的附加方法。虽然RESTful API有超时限制，但是消息队列没有这种缺点。因此，它有助于处理长时间运行的流程或延迟的消息。此外，它允许后端上更均匀的负载。它没有使用AWS Lambda的关键特性，因为Lambda很容易扩展，但是在处理集群时非常有用。最后，消息队列允许重试逻辑，这意味着失败的任务可以被多次发回。现在让我们更深入地了解一下AWS SQS公司。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Introduction to AWS SQS</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">SQS自动气象站简介</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">基本上，这是一个允许发送、接收和存储消息的AWS服务。它可以连接到任何处理后端。它有一个现收现付的系统，这使得它作为一个起点非常方便。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>AWS API gateway features</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">AWS API网关功能</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">AWS API的不同特性如下:</p>

<ul>

<li class="aLF-aPX-K0-aPE">它是高度可伸缩的，并且您不需要管理队列中的任何其他伸缩。</li>

<li class="aLF-aPX-K0-aPE">该服务处理读者对队列的访问，因此您不必实现它。</li>

<li class="aLF-aPX-K0-aPE">SQS有一个可定制的重试机制，增加了避免错误的概率，从而提高了整体速度。</li>

<li class="aLF-aPX-K0-aPE">SQS提供了非常简单的API，几乎可以在任何编程语言中使用。</li>

<li class="aLF-aPX-K0-aPE">最后，它提供了加密，这对于提高服务的安全性很有用。</li>

</ul>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>

AWS SQS pricing</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">AWS SQS定价</h1>

                

            

            

                

<p>SQS的主要优势之一是按用户付费系统，这非常简单。定价为每100万次请求50美分，每月前100万次请求是免费的。这使得它非常适合早期项目。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Creating an AWS SQS connection using an AWS Console</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">使用AWS控制台创建AWS SQS连接</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">在本节中，我们将首先创建一个AWS Lambda，然后在将SQS连接到AWS Lambda之前创建简单的查询服务。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Creating an AWS Lambda instance</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">创建AWS Lambda实例</h1>

                

            

            

                

<p>以下是创建AWS Lambda实例的步骤:</p>

<ol>

<li class="aLF-aPX-K0-aPE">首先，在名称下添加名称，选择运行时为Python 3.6，设置角色为选择现有角色，然后从现有角色中选择<kbd>lambda1</kbd>，点击创建函数，如下图所示:</li>

</ol>

<p class="CDPAlignCenter CDPAlign"><img src="img/b385768b-6389-4a9a-b300-15f253d821fb.png" style="width:44.50em;height:27.42em;"/></p>

<ol start="2">

<li class="aLF-aPX-K0-aPE">Lambda函数已创建，如下面的屏幕截图所示:</li>

</ol>

<p class="CDPAlignCenter CDPAlign"><img src="img/8089ef55-5533-4e14-8202-9c5019c94c65.png" style="width:44.50em;height:27.92em;"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<ol start="3">

<li>接下来，切换到SQS，通过选择Create New Queue创建一个SQS队列:</li>

</ol>

<p class="CDPAlignCenter CDPAlign"><img src="img/21706e6c-9e8f-4625-9f1d-0959623d93c0.png" style="width:43.92em;height:11.00em;"/></p>

<ol start="4">

<li>在创建一个名为testLambda的队列后，我们得到了SQS ARN，如下图所示:</li>

</ol>

<p class="CDPAlignCenter CDPAlign"><img src="img/ec3309d6-7bfb-4622-91c7-1275fda63a64.png" style="width:46.42em;height:18.17em;"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<p>5.从左侧的设计器选项卡中，选择SQS作为触发器:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/bc60d8d0-5246-477b-b9eb-ff3fe1531127.png" style="width:45.42em;height:15.75em;"/></p>

<ol start="6">

<li>我们将通过从队列操作下拉列表中选择发送消息来向队列发送一些消息:</li>

</ol>

<p class="CDPAlignCenter CDPAlign"><img src="img/ed4cad1c-a03e-4867-960f-b11cc4bf5a2a.png" style="width:43.75em;height:27.25em;"/></p>

<ol start="7">

<li class="CDPAlignLeft CDPAlign">如您所见，我们只有一条可用的消息，这意味着它们都被Lambda使用了，如下图所示:</li>

</ol>

<p class="CDPAlignCenter CDPAlign"><img src="img/df0aaea3-c35d-4cab-9ebc-5c4a60f81224.png" style="width:44.75em;height:16.75em;"/></p>

<p>8.通过单击“Monitoring ”,我们将获得如下所示的详细概述:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/0113f961-b532-4d60-8549-d41511dae11e.png"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<ol start="9">

<li class="CDPAlignLeft CDPAlign">我们还可以通过单击CloudWatch中的View logs来查看日志详细信息，如前面的屏幕截图所示。每个开始和结束都意味着对每个消息的调用。</li>

</ol>

<p>下一节涉及使用无服务器框架创建AWS Lambda的AWS SQS连接。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Creating an AWS SQS connection using the serverless framework</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">使用无服务器框架创建AWS SQS连接</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">为了创建SQS连接，我们有主Python文件和无服务器配置文件。配置文件会有点复杂。我们需要在参考资料部分定义SQS，编辑成Lambda的事件源，然后使Lambda能够从SQS读取。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>The Python file</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">Python文件</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">Python文件的主要区别在于，我们将写入另一个SQS查询，而不是返回字符串，如下所示:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/bc7425d7-37a2-48f1-b35b-782328043304.png" style="width:24.75em;height:13.33em;"/></p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Code</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">密码</h1>

                

            

            

                

<p>在开始编写代码之前，我们首先需要部署无服务器框架，然后我们需要使用命令行界面检查它是否运行。我们将使用<kbd>index.py</kbd>文件和<kbd>serverless.yml</kbd>配置文件运行代码。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>serverless.yml</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">无服务器. yml</h1>

                

            

            

                

<p>在<kbd>serverless.yml</kbd>文件中，我们可以看到我们在前面章节中讨论的所有部分，特别是我们定义访问查询的角色的部分，我们将从那里读取消息，我们的Lambda将向那里写入消息。下面的代码给出了解释:</p>

<pre>Effect: "Allow"<br/>Action:<br/>    "sqs:ReceiveMessage"<br/>    "sqs:DeleteMessage"<br/>    "sqs:GetQueueAttributes"<br/>Resource:<br/>    arn:aws:sqs:#{AWS::Region}:#{AWS::AccountId}:ReadSQS</pre>

<p>我们还必须定义其中一个查询将作为事件源，如下所示:</p>

<pre>events:<br/>    sqs:<br/>      arn:<br/>        Fn::GetAtt:<br/>          ReadSQS<br/>          Arn</pre>

<p>最后，我们定义查询，可以在资源部分执行，如代码所示:</p>

<pre>resources:<br/>  Resources: <br/>    WriteSQS: <br/>      Type: AWS::SQS::Queue<br/>      Properties:<br/>        QueueName: "WriteSQS"<br/>    ReadSQS: <br/>     Type: AWS::SQS::Queue<br/>     Properties:<br/>        QueueName: "ReadSQS"</pre>

<p>此外，我们将需要使用插件<kbd>serverless-pseudo-parameters</kbd>，我们将安装它:</p>

<pre>plugins:<br/>  - serverless-pseudo-parameters</pre>

<p>我们需要从<kbd>deployment</kbd>包中移除包含前面插件的包，如下所示:</p>

<pre>package:<br/>  exclude:<br/>    - node_modules/**</pre>

<p>接下来是使用这个插件来访问我们使用的地区的ID和我们的帐户ID，如下所示:</p>

<pre>Resource:<br/>  - arn:aws:sqs:#{AWS::Region}:#{AWS::AccountId}:ReadSQS<br/>Effect: "Allow"<br/>Action:<br/>  - "sqs:SendMessage"<br/>  - "sqs:GetQueueUrl"<br/>Resource:<br/>  - arn:aws:sqs:#{AWS::Region}:#{AWS::AccountId}:WriteSQS</pre>

<p class="mce-root"/>

<p>没有这个插件，你也可以访问帐号ID和地区ID，也可以手动查找。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>index.py</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">索引. py</h1>

                

            

            

                

<p><kbd>index.py</kbd>文件非常简单。我们只是阅读收到的信息，然后把它们写成SQS。下面显示了<kbd>index.py</kbd>的代码:</p>

<pre>import boto3<br/><br/>def handler(event,context):<br/>    for message in event['Records']:<br/>        client = boto3.client('sqs')<br/>        sqsAddress = client.get_queue_url(QueueName='WriteSQS')<br/>        response = client.send_message(QueueUrl=sqsAddress['QueueUrl'],<br/>                                        MessageBody=message['body'])<br/>    return</pre>

<p>我们将在命令行中看到前面的<kbd>index.py</kbd>和<kbd>serverless.yml</kbd>文件:</p>

<p>首先，我们需要安装插件，<kbd>serverless-pseudo-parameters</kbd>:</p>

<pre><strong>npm install serverless-pseudo-parameters</strong></pre>

<p>输出如下所示:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/9dd7aebe-03eb-4ce7-a058-f94aedccba8a.png"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<p>接下来，我们将使用以下命令部署Lambda:</p>

<pre>serverless deploy</pre>

<p>如您所见，插件用实际的基本区域和帐户替换了区域，如下图所示:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/142a3105-5000-478e-b270-2200cdb679cd.png"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<p>要通过队列发送消息，首先我们需要使用以下命令找到队列URL:</p>

<pre><strong>aws sqs get-queue-url --queue-name ReadSQS</strong></pre>

<p>使用队列URL，我们可以发送消息。我们看到该命令在这里成功执行:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/b4762bea-b362-4ada-8bad-fd11a49424fd.png"/></p>

<p>现在我们可以从SQS队列中读到同样的信息。基本上，这里我们可以检查Lambda是否收到了我们发送的消息，也就是<kbd>Hello world1</kbd>，并发送它来编写SQL。我们看到Lambda成功运行，并且我们可以在下面的屏幕截图中看到结果消息<kbd>Hello world1</kbd>:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/8ff07274-2898-49de-a34a-7b2814427375.png" style="width:47.58em;height:23.75em;"/></p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Example project – deep learning pipeline</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">示例项目–深度学习管道</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">在项目文件中，我们有主Python文件、无服务器配置文件、库文件和一个初始模块。配置文件将与我们在上一章中使用的文件相同。我们将查看Python文件。我们的Python文件的主要区别在于，我们将向另一个SQS查询发送一条消息，而不是返回字符串。此外，我们将让Lambda接受消息中图像的链接，然后应用module来构造它。部署将类似于上一节中的部署。</p>

<p>我们将跳过模型的部署，因为我们之前已经讨论过了。</p>

<p class="mce-root"/>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Code</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">密码</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">首先，我们需要部署无服务器框架，然后我们可以使用命令行界面检查它是否运行。我们有<kbd>index.py</kbd>文件和<kbd>serverless.yml</kbd>配置文件。我们还有TensorFlow的库和无服务器框架的预装插件。</p>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Configuration file - serverless.yml</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">配置文件- serverless.yml</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">我们可以看到当前的配置文件取自前面的章节。</p>

<p class="aLF-aPX-K0-aPE">我们有一个存放模型的桶，如下面的代码片段所示:</p>

<pre>Effect: "Allow"<br/>Action:<br/>  - "s3:ListBucket"<br/>Resource:<br/>  - arn:aws:s3:::serverlessdeeplearning<br/>Effect: "Allow"<br/>Action:<br/>  - "s3:GetObject"<br/>Resource:<br/>  - arn:aws:s3:::serverlessdeeplearning/*</pre>

<p class="aLF-aPX-K0-aPE">Lambda和资源有一个事件源，如下面的代码片段所示:</p>

<pre>- sqs:<br/>    arn:<br/>      Fn::GetAtt:<br/>        - DLReadSQS<br/>        - Arn</pre>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>index.py</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">索引. py</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">在<kbd>index.py</kbd>文件中，脚本看起来与前一节中的一样。添加了一个额外的部分，从消息中读取URL，并将结果写入另一个队列。以下是<kbd>index.py</kbd>的代码片段:</p>

<pre>import boto3<br/>import numpy as np<br/>import tensorflow as tf<br/>import os.path<br/>import re<br/>from urllib.request import urlretrieve<br/>import json<br/>SESSION = None<br/>strBucket = 'serverlessdeeplearning'<br/>def handler(event, context):<br/>    global strBucket<br/>    global SESSION<br/>    if not os.path.exists('/tmp/imagenet/'):<br/>       os.makedirs('/tmp/imagenet/')<br/>       ...</pre>

<p>下面的屏幕截图显示了我们检索图像并在其上运行模型的部分，因此，我们将模型的结果写入另一个队列，如下所示:</p>

<pre>if ('Records' in event):<br/>    for message in event['Records']:<br/>        urlretrieve(message['body'].strip('\''), strFile)<br/>        vecResult = run_inference_on_image(strFile)<br/>        client = boto3.client('sqs')<br/>        sqsAddress = client.get_queue_url(QueueName='DLWriteSQS')<br/>        response = client.send_message(QueueUrl=sqsAddress['QueueUrl'],<br/>                                       MessageBody=vecResult[0])<br/> else:<br/>        downloadFromS3(strBucket,'imagenet/inputimage.png',strFile)<br/>        strResult = run_inference_on_image(strFile)</pre>

<p>现在让我们部署服务，如下所示:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/27e1f796-47b8-4291-a5d8-4ddc64f8cc6f.png"/></p>

<p>我们将把带有URL的消息发送到第一个队列。这可以通过命令行界面完成:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/e6c11837-4ede-4d69-9d6e-1c912ec9d3ec.png"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<p>我们可以从另一个队列中读取发送的消息，如下所示:</p>

<p class="CDPAlignCenter CDPAlign"><img src="img/05cee0bc-e1e1-4439-bd50-381b227977bd.png"/></p>

<p class="CDPAlignCenter CDPAlign"/>

<p class="mce-root"/>

<p class="mce-root"/>





            



            

        

    </body>



</html>
<html xmlns:epub="http://www.idpf.org/2007/ops">

    <head>

        <title>Summary</title>

        

        <meta charset="utf-8"/>

<meta content="urn:uuid:47c30fe0-708a-4ee4-a010-a72f15252cad" name="Adept.expected.resource"/>

    </head>



    <body>

        



                            

                    <h1 class="header-title">摘要</h1>

                

            

            

                

<p class="aLF-aPX-K0-aPE">在这一章中，我们介绍了AWS SQS，包括它的功能和定价。我们还使用AWS控制台和无服务器框架创建了AWS SQS连接。</p>

<p>我们了解了<kbd>serverless.yml</kbd>配置文件和<kbd>index.py</kbd>文件的部署。本章以一个示例项目结束，这是一个深度学习管道。</p>

<p>在下一章中，我们将学习通过连接AWS Lambda实例和AWS函数来创建交叉工作流，在这里我们将学习如何创建深度学习工作流。</p>





            



            

        

    </body>



</html></body></html>